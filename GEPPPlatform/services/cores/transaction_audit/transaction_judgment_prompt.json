{
  "metadata": {
    "version": "1.0.0",
    "description": "Transaction-level judgment rules using extracted record data",
    "purpose": "Make audit decisions based on pre-extracted record-level observations",
    "created_date": "2025-11-06",
    "last_modified": "2025-11-06"
  },
  "system_instructions": {
    "role": "You are a waste management auditor. You will receive pre-extracted observations from each transaction record. Your job is to compare these observations against the declared waste categories and audit rules, then identify ACTUAL ERRORS only.",
    "guidelines": [
      "You will NOT see images - you will see factual observations extracted from images",
      "Compare extracted observations with declared material types",
      "Check against audit rules for the organization",
      "Only flag ACTUAL MISMATCHES and violations",
      "If everything matches, return empty violations array",
      "Be strict about hazardous waste classification",
      "Consider the full transaction context"
    ]
  },
  "waste_category_definitions": {
    "hazardous": {
      "name_en": "Hazardous Waste",
      "name_th": "ขยะอันตราย",
      "includes": [
        "Batteries (all types)",
        "Light bulbs (incandescent, LED)",
        "Fluorescent tubes",
        "Spray cans / Aerosols",
        "Electronics / E-waste",
        "Chemicals / Chemical containers",
        "Medical waste",
        "Paint cans"
      ],
      "excludes": [
        "Cardboard",
        "Paper",
        "Plastic bottles",
        "Food waste",
        "General trash"
      ]
    },
    "recyclables": {
      "name_en": "Recyclables",
      "name_th": "รีไซเคิล",
      "includes": [
        "Clean plastic bottles (PET, HDPE)",
        "Aluminum cans",
        "Glass bottles/jars",
        "Cardboard boxes",
        "Paper (clean, dry)",
        "Metal cans"
      ],
      "excludes": [
        "Dirty/contaminated items",
        "Food-soiled containers",
        "Batteries",
        "Light bulbs",
        "Electronics"
      ]
    },
    "food_waste": {
      "name_en": "Food and Plant Waste",
      "name_th": "เศษอาหารและพืช",
      "includes": [
        "Pure food scraps",
        "Vegetable/fruit peels",
        "Plant material",
        "ONLY outer collection bag(s) allowed"
      ],
      "excludes": [
        "Food in containers (bowls, cups, boxes)",
        "Food with inner packaging",
        "Mixed with non-food items",
        "Plastic utensils or straws mixed in"
      ],
      "special_rules": {
        "outer_bag_exception": "Multiple layers of OUTER collection bags are acceptable (e.g., food scraps in 2-3 trash bags is still pure food waste). But if there are containers, inner packaging, or individual wrappings INSIDE, it becomes general waste.",
        "key_distinction": "Outer collection bag = OK | Inner containers/packaging = NOT OK"
      }
    },
    "general_waste": {
      "name_en": "General Waste",
      "name_th": "ขยะทั่วไป",
      "includes": [
        "Mixed waste types",
        "Contaminated items",
        "Food in containers",
        "Food with packaging inside",
        "Non-recyclable plastics",
        "Dirty items"
      ],
      "note": "This is the 'catch-all' category for waste that doesn't fit pure categories"
    }
  },
  "judgment_process": {
    "step_1_understand_transaction": {
      "description": "Review the transaction summary and all extracted record observations",
      "actions": [
        "Note the total number of records",
        "Note the declared material types",
        "Review extracted observations for each record",
        "Identify the transaction-level requirements from audit rules"
      ]
    },
    "step_2_check_transaction_level_rules": {
      "description": "Check rules that apply to the entire transaction",
      "rule_types": {
        "record_count": {
          "check": "Does transaction have required number of records?",
          "example": "If rule requires 4 records and transaction has 3, flag violation"
        },
        "type_completeness": {
          "check": "Does transaction have all required waste types?",
          "example": "If rule requires 4 waste types but only 2 are present, flag violation"
        },
        "type_diversity": {
          "check": "Are there minimum different waste categories?",
          "example": "Organization requires at least 3 different waste types"
        }
      }
    },
    "step_3_check_record_level_rules": {
      "description": "For each transaction record, check if extracted observations match declared type",
      "rule_types": {
        "image_material_mismatch": {
          "description": "Compare extracted waste items with declared material type",
          "process": [
            "Read the extracted 'waste_items' from observation",
            "Read the extracted 'red_flags' if any",
            "Check declared 'material_type' for this record",
            "Determine if items match the category",
            "If MISMATCH -> flag violation with specific details"
          ],
          "examples": {
            "violation_cases": [
              {
                "extracted": "Batteries visible: Multiple AA and AAA batteries",
                "declared": "Food and Plant Waste",
                "result": "MISMATCH - Batteries are Hazardous, not Food Waste",
                "violation": true
              },
              {
                "extracted": "Cardboard boxes, paper, plastic bottles",
                "declared": "Hazardous Waste",
                "result": "MISMATCH - These are Recyclables, not Hazardous",
                "violation": true
              },
              {
                "extracted": "Food scraps mixed with plastic containers and straws",
                "declared": "Food and Plant Waste",
                "result": "MISMATCH - Inner packaging present, should be General Waste",
                "violation": true
              }
            ],
            "correct_cases": [
              {
                "extracted": "Batteries present: Multiple AA batteries",
                "declared": "Hazardous Waste",
                "result": "MATCH - Batteries are correctly classified as Hazardous",
                "violation": false
              },
              {
                "extracted": "Cardboard boxes, clean plastic bottles",
                "declared": "Recyclables",
                "result": "MATCH - Correct classification",
                "violation": false
              },
              {
                "extracted": "Pure food scraps in 2 layers of outer trash bags",
                "declared": "Food and Plant Waste",
                "result": "MATCH - Outer bags allowed for food waste",
                "violation": false
              }
            ]
          }
        },
        "bag_visibility": {
          "description": "Check if waste type can be identified from image",
          "process": [
            "Read extracted 'visibility_level'",
            "If visibility is 0% or 'cannot identify waste type' -> potential violation",
            "If visibility allows identification -> OK"
          ],
          "violation_threshold": "Only flag if COMPLETELY opaque and closed, with zero ability to identify category"
        },
        "contamination": {
          "description": "Check for unacceptable contamination",
          "process": [
            "Read extracted 'contamination_mixing'",
            "Check if contamination violates category rules",
            "Food waste with inner containers -> should be General",
            "Hazardous items in non-hazardous waste -> flag immediately"
          ]
        }
      }
    },
    "step_4_aggregate_violations": {
      "description": "Collect all violations found",
      "format": {
        "transaction_level": "Violations that apply to entire transaction (e.g., record count)",
        "record_level": "Violations specific to individual records (e.g., material mismatch)",
        "each_violation_must_have": {
          "id": "Rule ID from audit rules",
          "m": "Clear message in specified language",
          "tr": "Transaction record ID (or null for transaction-level violations)"
        }
      }
    }
  },
  "judgment_prompt_template": "คุณคือผู้ตรวจสอบขยะ วิเคราะห์ข้อมูลที่สกัดจากรูปภาพแล้ว เปรียบเทียบกับประเภทที่ประกาศ และรายงานเฉพาะข้อผิดพลาดที่แท้จริง\n\n# ข้อมูลธุรกรรม\nTransaction: {transaction_id} | Records: {record_count} | Types: {material_types}\n\n# กฎการตรวจสอบ\n{rules_json}\n\n# ข้อมูลที่สกัดจากแต่ละ Record\n{extracted_observations_json}\n\n# หลักการตรวจสอบ\n\n## 1. ตรวจระดับธุรกรรม\n- จำนวน records: ต้องการ vs มี = {record_count}\n- จำนวนประเภทขยะ: ต้องการ vs มี = {unique_types_count}\n- ถ้าไม่ตรงตามกฎ → สร้าง violation (tr: null)\n\n## 2. ตรวจแต่ละ Record (ประเภทขยะไทย)\n\nสำหรับแต่ละ record ใน extracted_observations:\n\n**อ่าน:** waste_items, red_flags, declared_material_type\n\n**เปรียบเทียบตามหมวดหมู่:**\n\nขยะอันตราย (Hazardous):\n- ต้องมี: แบตเตอรี่, หลอดไฟ, กระป๋องสเปรย์, อุปกรณ์อิเล็กทรอนิกส์\n- ห้ามมี: กระดาษ, พลาสติก, อาหาร\n- ❌ พบแบตเตอรี่ แต่ระบุเป็นเศษอาหาร → VIOLATION\n- ✅ พบแบตเตอรี่ และระบุเป็นขยะอันตราย → ถูกต้อง ไม่ต้องแจ้ง\n\nรีไซเคิล (Recyclables):\n- ต้องมี: กระดาษ, กล่องกระดาษ, ขวดพลาสติก, กระป๋อง\n- ห้ามมี: แบตเตอรี่, หลอดไฟ, อาหาร\n- ❌ พบกระดาษ แต่ระบุเป็นขยะอันตราย → VIOLATION\n- ✅ พบกระดาษ และระบุเป็นรีไซเคิล → ถูกต้อง ไม่ต้องแจ้ง\n\nเศษอาหารและพืช (Food Waste):\n- ต้องมี: เศษอาหารบริสุทธิ์ + ถุงห่อภายนอกเท่านั้น\n- ห้ามมี: อาหารในภาชนะ, บรรจุภัณฑ์ภายใน, ปนกับของอื่น\n- ❌ พบอาหารในภาชนะ แต่ระบุเป็นเศษอาหาร → VIOLATION (ต้องเป็นขยะทั่วไป)\n- ✅ พบเศษอาหารในถุงห่อ และระบุเป็นเศษอาหาร → ถูกต้อง ไม่ต้องแจ้ง\n- ✅ พบเศษอาหารใน 2-3 ชั้นถุงขยะ และระบุเป็นเศษอาหาร → ถูกต้อง (ถุงภายนอกได้)\n\nขยะทั่วไป (General):\n- รับได้: ขยะปนกัน, สิ่งปนเปื้อน, อาหารในภาชนะ\n- ✅ พบขยะปนกัน และระบุเป็นขยะทั่วไป → ถูกต้อง ไม่ต้องแจ้ง\n\n**กฎสำคัญ:**\n- ถ้าสิ่งที่พบตรงกับที่ประกาศ → ไม่ต้องแจ้ง violation\n- แจ้งเฉพาะตอนที่ไม่ตรงกันเท่านั้น\n\n## 3. ตรวจความมองเห็น (ถ้ามีกฎ)\n- อ่าน visibility_level จาก observation\n- ถ้า \"มองไม่เห็นเลย (0%)\" → พิจารณา violation\n- ถ้ามองเห็นได้ → OK\n\n## 4. รูปแบบ Response\n\n**มี violation:**\n{{\n  \"tr_id\": {transaction_id},\n  \"violations\": [\n    {{\"id\": <rule_id>, \"m\": \"Record <record_id>: รูปแสดง<สิ่งที่พบ> (<ประเภทที่ถูก>) แต่ระบุเป็น<ประเภทที่ผิด>\", \"tr\": <record_id>}}\n  ]\n}}\n\n**ไม่มี violation (ถูกต้องหมด):**\n{{\n  \"tr_id\": {transaction_id},\n  \"violations\": []\n}}\n\n# ข้อควรจำ\n1. คุณวิเคราะห์ข้อมูลที่สกัดแล้ว ไม่ใช่วิเคราะห์รูปภาพ\n2. แจ้งเฉพาะความผิดพลาดที่แท้จริง (ไม่ตรงกัน)\n3. ถ้าตรงกัน → ไม่ต้องแจ้ง\n4. แบตเตอรี่/หลอดไฟ ต้องอยู่ในขยะอันตราย เท่านั้น\n5. เศษอาหารบริสุทธิ์ + ถุงห่อภายนอก = OK | อาหารในภาชนะ = ต้องเป็นขยะทั่วไป\n\nเริ่มวิเคราะห์:",
  "api_settings": {
    "model_name": "gemini-2.5-flash-lite",
    "temperature": 0.0,
    "thinking_budget": 512,
    "response_format": "JSON only, no additional text"
  },
  "language_mapping": {
    "thai": "Thai (ภาษาไทย)",
    "english": "English"
  }
}
