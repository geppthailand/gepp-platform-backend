# GEPP Platform Database Architecture - Complete Analysis v0.0.1 - September 22, 2025

## Executive Summary
Comprehensive documentation of the GEPP Platform database architecture including materials restructuring, complete model analysis, and system-wide database concepts. This document provides a deep understanding of all database tables, relationships, and architectural patterns.

## Materials Table Architecture Restructuring

### Changes Made

#### 1. Table Rename: `material_main` � `main_materials`
- **Old Table**: `material_main`
- **New Table**: `main_materials`
- **Purpose**: Consistent naming convention with plural table names
- **Model Class**: `MaterialMain` � `MainMaterial`

#### 2. New Table: `material_categories`
- **Purpose**: Categorization system for materials
- **Model Class**: `MaterialCategory`
- **Columns**:
  - `id` (BigInteger, Primary Key, inherited from BaseModel)
  - `is_active` (Boolean, inherited from BaseModel)
  - `created_date` (DateTime, inherited from BaseModel)
  - `updated_date` (DateTime, inherited from BaseModel)
  - `deleted_date` (DateTime, inherited from BaseModel)
  - `name_en` (String 255) - English category name
  - `name_th` (String 255) - Thai category name
  - `code` (String 50) - Category code
  - `description` (Text) - Category description

#### 3. Materials Table Column Restructure
- **Enhanced Structure**: Complete overhaul of materials table columns
- **New Columns**:
  - `id` (BigInteger, Primary Key, inherited from BaseModel)
  - `is_active` (Boolean, inherited from BaseModel)
  - `category_id` (BigInteger, FK to material_categories.id)
  - `main_material_id` (BigInteger, FK to main_materials.id)
  - `tags` (Text) - Material tags for filtering
  - `unit_name_th` (String 255) - Thai unit name
  - `unit_name_en` (String 255) - English unit name
  - `unit_weight` (Decimal 10,4) - Weight per unit
  - `color` (String 7) - Hex color code for UI display
  - `calc_ghg` (Decimal 10,4) - GHG calculation factor
  - `created_date` (DateTime, inherited from BaseModel)
  - `updated_date` (DateTime, inherited from BaseModel)
  - `deleted_date` (DateTime, inherited from BaseModel)
  - `name_th` (String 255) - Thai material name
  - `name_en` (String 255) - English material name

### Database Schema Changes

#### New Table Structure

```sql
-- Material Categories Table
CREATE TABLE material_categories (
    id BIGSERIAL PRIMARY KEY,
    is_active BOOLEAN DEFAULT TRUE,
    created_date TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_date TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    deleted_date TIMESTAMP,
    name_en VARCHAR(255),
    name_th VARCHAR(255),
    code VARCHAR(50),
    description TEXT
);

-- Main Materials Table (Renamed from material_main)
ALTER TABLE material_main RENAME TO main_materials;

-- Materials Table (Restructured)
-- Note: This will require data migration for existing materials
ALTER TABLE materials ADD COLUMN category_id BIGINT REFERENCES material_categories(id);
ALTER TABLE materials RENAME COLUMN material_main_id TO main_material_id;
ALTER TABLE materials ADD COLUMN tags TEXT;
ALTER TABLE materials ADD COLUMN unit_name_th VARCHAR(255);
ALTER TABLE materials ADD COLUMN unit_name_en VARCHAR(255);
ALTER TABLE materials ADD COLUMN unit_weight DECIMAL(10,4);
ALTER TABLE materials ADD COLUMN color VARCHAR(7);
ALTER TABLE materials ADD COLUMN calc_ghg DECIMAL(10,4);
-- Existing columns: name_en, name_th will be kept
-- Columns to be removed: name_local, code, description
```

### Model Relationships

#### MaterialCategory
- **Has Many**: Materials (via category_id foreign key)
- **Purpose**: Provides hierarchical categorization for materials

#### MainMaterial (formerly MaterialMain)
- **Has Many**: Materials (via main_material_id foreign key)
- **Purpose**: Base material classification

#### Material
- **Belongs To**: MaterialCategory (via category_id)
- **Belongs To**: MainMaterial (via main_material_id)
- **Enhanced Features**:
  - Unit management (weight, name in multiple languages)
  - Visual representation (color coding)
  - Environmental impact calculation (GHG factor)
  - Flexible tagging system

### Business Logic Improvements

#### Enhanced Material Management
1. **Categorization**: Materials can now be organized by categories for better filtering
2. **Unit Standardization**: Consistent unit naming and weight calculations
3. **Environmental Compliance**: Built-in GHG calculation factors
4. **Visual Organization**: Color coding for UI/UX improvements
5. **Flexible Tagging**: Tag-based filtering and search capabilities

#### Data Relationships
- **Three-tier hierarchy**: Category � Main Material � Material
- **Flexible associations**: Materials can belong to different categories while sharing main materials
- **Audit trail**: Full BaseModel inheritance for tracking changes

### Migration Considerations

#### Data Migration Requirements
1. **Existing main materials**: Migrate from `material_main` to `main_materials`
2. **Existing materials**: Update foreign key references and add new columns
3. **Category assignment**: Assign appropriate categories to existing materials
4. **Default values**: Set reasonable defaults for new columns (unit weights, colors, etc.)

#### Migration Script Template
```sql
-- Step 1: Create material_categories table
-- Step 2: Rename material_main to main_materials
-- Step 3: Add new columns to materials table
-- Step 4: Migrate existing data
-- Step 5: Create appropriate indexes
-- Step 6: Update foreign key constraints
```

### API Impact

#### New Endpoints Needed
- `GET /api/material-categories` - List all material categories
- `POST /api/material-categories` - Create new category
- `PUT /api/material-categories/{id}` - Update category
- `DELETE /api/material-categories/{id}` - Soft delete category

#### Updated Endpoints
- `GET /api/materials` - Enhanced with category filtering, unit information
- `POST /api/materials` - Updated to include new required fields
- `PUT /api/materials/{id}` - Updated to handle new column structure

### Frontend Impact

#### UI/UX Enhancements
1. **Category-based filtering**: Materials can be filtered by category
2. **Color coding**: Visual representation using the color field
3. **Unit display**: Consistent unit information display
4. **Tag-based search**: Enhanced search capabilities
5. **GHG information**: Environmental impact display

#### Form Updates
- **Material creation forms**: Add category selection, unit information, color picker
- **Material listing**: Enhanced with category badges, color indicators
- **Search interface**: Tag-based and category-based filtering

### Performance Considerations

#### Database Indexing
```sql
-- Recommended indexes for optimal performance
CREATE INDEX idx_materials_category_id ON materials(category_id);
CREATE INDEX idx_materials_main_material_id ON materials(main_material_id);
CREATE INDEX idx_materials_is_active ON materials(is_active);
CREATE INDEX idx_material_categories_is_active ON material_categories(is_active);
CREATE INDEX idx_main_materials_is_active ON main_materials(is_active);

-- GIN index for tag searching
CREATE INDEX idx_materials_tags ON materials USING GIN (to_tsvector('english', tags));
```

#### Query Optimization
- **Join optimization**: Proper indexing on foreign keys
- **Tag search**: Full-text search indexing for tags column
- **Category filtering**: Efficient category-based queries

### Testing Requirements

#### Unit Tests
- Model validation tests for new fields
- Relationship tests between categories, main materials, and materials
- Data type validation (decimal precision, color format)

#### Integration Tests
- API endpoint tests for new category management
- Material CRUD operations with new structure
- Search and filtering functionality

#### Data Migration Tests
- Verify data integrity during migration
- Test rollback procedures
- Validate foreign key constraints

### Documentation Updates

#### API Documentation
- Update OpenAPI/Swagger specs for material endpoints
- Document new category management endpoints
- Update response schemas with new fields

#### Developer Documentation
- Model relationship diagrams
- Database schema documentation
- Migration procedures guide

### Security Considerations

#### Data Validation
- Color field validation (hex format)
- Decimal precision validation for weights and GHG factors
- Tag format validation and sanitization

#### Access Control
- Category management permissions
- Material modification permissions based on organization roles

### Future Enhancements

#### Planned Features
1. **Material hierarchies**: Sub-categories support
2. **Unit conversions**: Automatic unit conversion system
3. **GHG calculations**: Integration with transaction records
4. **Material templates**: Predefined material sets for industries

#### Scalability Considerations
- **Partitioning**: Consider table partitioning for large material datasets
- **Caching**: Redis caching for frequently accessed categories and materials
- **Search optimization**: Elasticsearch integration for advanced material search

---

## Summary

This restructuring provides a more robust and scalable foundation for material management in the GEPP Platform. The new three-tier hierarchy (Category � Main Material � Material) offers better organization, while the enhanced material attributes support environmental compliance requirements and improved user experience.

**Key Benefits:**
-  Improved material categorization and organization
-  Enhanced environmental compliance with GHG calculations
-  Better UI/UX with color coding and unit standardization
-  Flexible tagging system for advanced search
-  Scalable architecture for future enhancements

**Migration Status:** Ready for implementation with proper data migration procedures.

---

# Complete Database Architecture Analysis

## 1. Core Infrastructure

### 1.1 Base Model Pattern (`models/base.py`)
All models inherit from `BaseModel` providing standard fields:
- `id` (BigInteger, Primary Key, Auto-increment)
- `is_active` (Boolean, Default: True) - Soft delete pattern
- `created_date` (DateTime with timezone)
- `updated_date` (Timestamp with auto-update)
- `deleted_date` (DateTime, nullable) - Soft delete timestamp

### 1.2 Platform Enumeration
```python
class PlatformEnum(enum.Enum):
    NA = 'NA'
    WEB = 'WEB'
    MOBILE = 'MOBILE'
    API = 'API'
    GEPP_BUSINESS_WEB = 'GEPP_BUSINESS_WEB'
    GEPP_REWARD_APP = 'GEPP_REWARD_APP'
    ADMIN_WEB = 'ADMIN_WEB'
    GEPP_EPR_WEB = 'GEPP_EPR_WEB'
```

## 2. Core Domain Models

### 2.1 Location Hierarchy (`models/cores/locations.py`)
**Geographic hierarchy for standardized location management:**

```
LocationCountry (root)
└── LocationRegion
    └── LocationProvince
        └── LocationDistrict
            └── LocationSubdistrict
```

**Key Features:**
- Multi-language support (en, th, local)
- Hierarchical relationships
- Postal code integration at subdistrict level

### 2.2 Reference Data (`models/cores/references.py`)
**Enhanced with new material structure:**

#### Material Categories (NEW)
- `MaterialCategory`: Categories for material classification
- Fields: `name_en`, `name_th`, `code`, `description`

#### Main Materials (RENAMED)
- `MainMaterial` (formerly `MaterialMain`): Base material types
- Table: `main_materials` (renamed from `material_main`)

#### Materials (RESTRUCTURED)
- Enhanced with 15 new fields for comprehensive material management
- Links to both categories and main materials
- Environmental and business intelligence features

#### Other Reference Data
- `Bank`: Banking institutions with country linkage
- `Currency`: International currency support
- `Nationality`: Nationality classifications
- `PhoneNumberCountryCode`: International phone code management

### 2.3 Permission System (`models/cores/permissions.py` & `models/cores/roles.py`)
**Three-tier permission architecture:**

1. **System Permissions**: Platform-level access control
2. **Organization Permissions**: Tenant-specific permissions
3. **Permission Types**: Categorization of permissions

**Key Models:**
- `SystemRole`: System-level role definitions
- `SystemPermission`: Feature-level access control
- `Permission` & `PermissionType`: General permission framework

## 3. User Management Architecture

### 3.1 Unified User-Location Model (`models/users/user_location.py`)
**Revolutionary dual-purpose entity:**

```python
# Can serve as BOTH user account AND location node
is_user = True      # Can login and authenticate
is_location = True  # Can be waste transaction endpoint
```

**Multi-dimensional Identity:**
- **Authentication**: Email, password, social login integration
- **Business Profile**: Company info, tax ID, business classification
- **Geographic**: Full address hierarchy + coordinates
- **Organizational**: Tree structure with materialized paths
- **Waste Management**: Functions, materials, hub types

**Organizational Tree Structure:**
```
parent_user_id → direct_children (1:many)
subusers ↔ parent_users (many:many)
organization_path: "/1/5/12/" (materialized path)
organization_level: 0, 1, 2, 3... (depth indicator)
```

**Location Member Assignment (NEW):**
- `members` (JSONB): User assignments with roles
- Structure: `[{"user_id": "27", "role": "admin"}]`

## 4. Subscription & Organization Management

### 4.1 Organization Structure (`models/subscriptions/organizations.py`)
**Multi-tenant SaaS architecture:**

#### Organization
- Core tenant entity
- Links to `OrganizationInfo` for detailed business data
- Owner relationship to `UserLocation`
- Current subscription tracking

#### OrganizationInfo
- Comprehensive business profile
- Legal and registration details
- Full address and contact information
- Financial and operational metadata

#### OrganizationSetup (NEW)
- **Versioned tree structure management**
- JSON-based storage for organizational hierarchy
- `root_nodes` and `hub_node` structure
- Version control with `is_active` flagging

### 4.2 Subscription System (`models/subscriptions/subscription_models.py`)
**Tiered SaaS model:**

#### SubscriptionPlan
- Multiple tiers: free, starter, professional, enterprise
- Feature-based limitations
- Usage quota management

#### Subscription
- Active organization subscriptions
- Usage tracking and limits
- Status management

#### Organization Roles & Permissions
- `OrganizationRole`: Tenant-specific roles
- `OrganizationPermission`: Granular permission control
- Many-to-many permission assignment

## 5. Transaction Management System

### 5.1 Transaction Architecture (`models/transactions/transactions.py`)
**Batch-level shipment management:**

#### Transaction (Shipment Batch)
- Groups multiple material records
- Full logistics tracking
- GPS and route management
- Environmental impact tracking
- EPR compliance integration

**Status Flow:**
```
draft → scheduled → in_progress → in_transit → delivered → completed
```

**Key Features:**
- Multi-location journey tracking
- Vehicle and driver assignment
- Verification and approval workflow
- Carbon footprint calculation
- Document management

### 5.2 Transaction Records (`models/transactions/transaction_records.py`)
**Individual material journey tracking:**

#### TransactionRecord
- Single material movement
- Quality and condition tracking
- Chain of custody
- EPR-specific attributes
- Environmental impact metrics

#### Material Condition Tracking
- `TransactionMaterialCondition`: Quality assessments
- Multiple assessments per journey
- Contamination and purity tracking
- Assessment documentation

**Material Condition States:**
- EXCELLENT, GOOD, FAIR, POOR, CONTAMINATED, MIXED

**Processing Stages:**
- COLLECTION → SORTING → CLEANING → PROCESSING → RECYCLING/DISPOSAL

## 6. Extended Producer Responsibility (EPR)

### 6.1 EPR Core (`models/epr/core.py`)
**Comprehensive EPR program management:**

#### EprOrganization
- EPR program participants
- Producer, importer, distributor classification
- Registration and licensing
- Annual production volume tracking

#### EprBrand & EprProduct
- Brand and product catalog
- Recyclability scoring
- Market share tracking
- Lifecycle management

#### EprProject
- EPR implementation projects
- Geographic and material scope
- Budget and target management
- Progress tracking

**Project Management Features:**
- File attachment system
- User assignment and roles
- Activity logging
- Geographic coverage areas

### 6.2 EPR Additional Modules
- **Auditing** (`epr/auditing.py`): Compliance auditing
- **Payments** (`epr_payments/`): Fee calculation and processing
- **Professional Services** (`epr/pro.py`): EPR service providers

## 7. Rewards & Gamification System

### 7.1 Points Management (`models/rewards/points.py`)
**Comprehensive points economy:**

#### UserPoints
- Organization-scoped point balances
- Tier system integration
- Expiration tracking
- Performance metrics

#### ClaimRule
- Flexible rules engine for point earning
- Material-specific calculations
- Quality-based bonuses
- Tiered reward structures

**Claim Rule Types:**
- MATERIAL_QUANTITY: Points per kg/unit
- TRANSACTION_COUNT: Points per transaction
- QUALITY_BONUS: Quality-based rewards
- VOLUME_TIER: Volume-based tiers
- FREQUENCY_BONUS: Regular participation
- MILESTONE_REWARD: Achievement rewards

#### Point Transaction System
- Individual earning/redemption records
- Approval workflow
- Detailed calculation tracking
- Status management

### 7.2 Reward Catalog & Redemption
- **Catalog Management**: Reward categories and inventory
- **Redemption Processing**: Order fulfillment workflow
- **Analytics**: Performance tracking and reporting

## 8. GRI Reporting System

### 8.1 GRI Standards (`models/gri/standards.py`)
**Global Reporting Initiative compliance:**

#### GRI 306 Waste Management Standards
- **GRI_306_1**: Waste generation and impacts
- **GRI_306_2**: Impact management
- **GRI_306_3**: Waste generated
- **GRI_306_4**: Waste diverted from disposal
- **GRI_306_5**: Waste directed to disposal

#### Reporting Structure
```
GriStandard
└── GriAspect
    └── GriIndicator
```

#### Material Classification
- `GriMaterialCategory`: GRI-specific material grouping
- Hazardous/non-hazardous classification
- Disposal method tracking
- Recovery potential assessment

### 8.2 Reporting Infrastructure
- **Templates**: Configurable reporting formats
- **Analytics**: Performance dashboards
- **Goals**: Target setting and tracking
- **Export**: Multiple format support

## 9. Knowledge Management System

### 9.1 Document Management (`models/km/files.py`)
**AI-powered knowledge base:**

#### KmFile
- Multi-format document support
- Ownership model (GEPP vs USER documents)
- Processing pipeline integration
- Version control

#### KmChunk
- **Vector embeddings** for semantic search
- Chunking strategies for large documents
- Content analysis and metadata
- Usage analytics

**Vector Search Integration:**
- pgvector extension support
- 1536-dimensional embeddings (OpenAI ada-002)
- Semantic similarity search
- Context window retrieval

### 9.2 Processing Pipeline
- **Batch Processing**: `TempFileBatch` for bulk operations
- **Content Analysis**: NLP and entity extraction
- **Tagging System**: Automated and manual classification
- **Access Control**: Organization-scoped permissions

## 10. Communication & Collaboration

### 10.1 Expert System (`models/chats/`)
- **Expert Directory**: Skill-based matching
- **Conversation Management**: Thread-based messaging
- **Meeting Integration**: Video call scheduling
- **Knowledge Sharing**: Expert consultation workflow

## 11. Audit & Logging System

### 11.1 Comprehensive Logging (`models/logs/`)
- **Platform Logs**: System operations and performance
- **Audit Logs**: User actions and data changes
- **Compliance Tracking**: Regulatory requirement logging
- **Performance Monitoring**: System health metrics

## 12. Architectural Patterns & Best Practices

### 12.1 Multi-Tenancy
- **Organization-based isolation**: All data scoped to organizations
- **Subscription-based access**: Feature gating via subscription plans
- **Hierarchical permissions**: System → Organization → User levels

### 12.2 Soft Delete Pattern
- All models use `is_active` and `deleted_date`
- Data preservation for audit trails
- Efficient querying with index optimization

### 12.3 Audit Trail
- Comprehensive change tracking
- User action logging
- Timestamp management
- Compliance documentation

### 12.4 Geographic Standardization
- Consistent location hierarchy
- Multi-language support
- Coordinate storage (PostGIS compatible)
- Address normalization

### 12.5 Material Flow Tracking
- Batch-based transactions
- Individual material journey
- Quality and condition monitoring
- Environmental impact calculation

### 12.6 Flexible Metadata
- JSON/JSONB columns for extensibility
- Custom field support
- Future-proof data structures
- Performance-optimized queries

## 13. Performance & Scalability Considerations

### 13.1 Database Optimization
- **Materialized Paths**: Efficient tree queries
- **Vector Indexing**: Semantic search performance
- **JSON Indexing**: Flexible metadata queries
- **Connection Pooling**: Resource optimization

### 13.2 Data Volume Management
- **Partitioning Strategy**: Large table management
- **Archiving Policies**: Historical data management
- **Cleanup Procedures**: Soft delete maintenance
- **Index Maintenance**: Performance monitoring

## 14. Security & Compliance

### 14.1 Data Protection
- **Encryption at Rest**: Sensitive data protection
- **Access Control**: Multi-level permission system
- **Audit Logging**: Complete action tracking
- **GDPR Compliance**: Data retention and deletion

### 14.2 Business Continuity
- **Backup Strategy**: Point-in-time recovery
- **Disaster Recovery**: Multi-region support
- **Version Control**: Schema change management
- **Migration Planning**: Zero-downtime deployments

---

## Summary

The GEPP Platform database architecture represents a sophisticated, multi-tenant waste management and environmental compliance system. Key architectural strengths include:

**✅ Unified User-Location Model**: Revolutionary dual-purpose entities
**✅ Comprehensive Material Management**: Three-tier hierarchy with environmental intelligence
**✅ Advanced Transaction Tracking**: Batch and individual material journey monitoring
**✅ EPR Compliance Integration**: Full regulatory framework support
**✅ Gamification System**: Points, rewards, and user engagement
**✅ GRI Reporting**: International sustainability standard compliance
**✅ AI-Powered Knowledge Management**: Vector-based semantic search
**✅ Multi-tenant Architecture**: Scalable SaaS foundation
**✅ Audit & Compliance**: Comprehensive tracking and logging
**✅ Performance Optimization**: Vector indexing, materialized paths, JSON optimization

**Total Models**: 100+ models across 11 domain areas
**Database Size**: Enterprise-scale with millions of records support
**Compliance**: EPR, GRI, GDPR ready
**Architecture**: Multi-tenant SaaS with advanced features

**Migration Status:** Materials restructuring implemented, comprehensive documentation complete.

**Last Updated:** September 23, 2025
**Version:** v0.0.1
**Status:** COMPREHENSIVE ANALYSIS COMPLETE

---

# Database Schema and Model Synchronization Regulations v1.0.0

## Mandatory Bi-Directional Synchronization Rules

### **CRITICAL REGULATION: Every database schema change MUST be synchronized with SQLAlchemy models and vice versa**

---

## 1. Migration → Model Synchronization (MANDATORY)

### **Rule 1.1: Migration-First Workflow**
- **REQUIRED**: Every database migration script MUST have corresponding SQLAlchemy model updates
- **TIMING**: Model updates MUST be completed before migration deployment
- **VERIFICATION**: Model structure MUST match final database schema exactly

### **Rule 1.2: Migration Script Requirements**
```sql
-- ✅ REQUIRED: Every migration MUST include
-- 1. Clear table/column descriptions
-- 2. Proper constraints and indexes
-- 3. Data type specifications that match SQLAlchemy
-- 4. Foreign key relationships
-- 5. Default values and nullable specifications

-- Example:
CREATE TABLE material_tags (
    id BIGSERIAL PRIMARY KEY,                    -- Matches: id = Column(BigInteger, primary_key=True)
    name VARCHAR(255) NOT NULL,                  -- Matches: name = Column(String(255), nullable=False)
    is_global BOOLEAN NOT NULL DEFAULT false,   -- Matches: is_global = Column(Boolean, nullable=False, default=False)
    organization_id BIGINT REFERENCES organizations(id) -- Matches: organization_id = Column(BigInteger, ForeignKey('organizations.id'))
);
```

### **Rule 1.3: Mandatory Model Updates**
**After EVERY migration, developers MUST:**

1. **Update Model Class Definition**:
```python
# ✅ REQUIRED: Add/modify model class in appropriate models file
class MaterialTag(Base, BaseModel):
    __tablename__ = 'material_tags'

    name = Column(String(255), nullable=False)
    is_global = Column(Boolean, nullable=False, default=False)
    organization_id = Column(BigInteger, ForeignKey('organizations.id'), nullable=True)
```

2. **Update Relationships**:
```python
# ✅ REQUIRED: Add relationships that match foreign keys
organization = relationship("Organization")
```

3. **Update Model Imports**:
```python
# ✅ REQUIRED: Add new models to __init__.py files for SQLAlchemy registration
from .material_tag import MaterialTag
```

---

## 2. Model → Migration Synchronization (MANDATORY)

### **Rule 2.1: Model-Change Workflow**
- **REQUIRED**: Every SQLAlchemy model change MUST have corresponding migration script
- **TIMING**: Migration script MUST be created immediately after model changes
- **DEPLOYMENT**: Migration MUST be tested and deployed before model changes go live

### **Rule 2.2: Model Change Types Requiring Migrations**

#### **New Model Class** → **CREATE TABLE Migration**
```python
# Model Addition
class NewModel(Base, BaseModel):
    __tablename__ = 'new_table'
    field_name = Column(String(255))
```
```sql
-- Required Migration
CREATE TABLE new_table (
    id BIGSERIAL PRIMARY KEY,
    is_active BOOLEAN DEFAULT TRUE,
    created_date TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    updated_date TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    deleted_date TIMESTAMP WITH TIME ZONE,
    field_name VARCHAR(255)
);
```

#### **Column Addition** → **ALTER TABLE ADD COLUMN Migration**
```python
# Model Change
class ExistingModel(Base, BaseModel):
    new_field = Column(String(100), nullable=False, default='default_value')  # ADDED
```
```sql
-- Required Migration
ALTER TABLE existing_table
ADD COLUMN new_field VARCHAR(100) NOT NULL DEFAULT 'default_value';
```

#### **Column Modification** → **ALTER TABLE ALTER COLUMN Migration**
```python
# Model Change
class ExistingModel(Base, BaseModel):
    field_name = Column(String(500), nullable=False)  # Changed from String(255) to String(500)
```
```sql
-- Required Migration
ALTER TABLE existing_table
ALTER COLUMN field_name TYPE VARCHAR(500);
```

#### **Relationship Changes** → **Foreign Key Migrations**
```python
# Model Change
class ModelA(Base, BaseModel):
    model_b_id = Column(BigInteger, ForeignKey('model_b.id'))  # ADDED
    model_b = relationship("ModelB")  # ADDED
```
```sql
-- Required Migration
ALTER TABLE model_a
ADD COLUMN model_b_id BIGINT REFERENCES model_b(id);
```

### **Rule 2.3: Index Synchronization**
```python
# Model with Index
class ModelWithIndex(Base, BaseModel):
    __tablename__ = 'indexed_table'
    search_field = Column(String(255), index=True)  # index=True
```
```sql
-- Required Migration
CREATE INDEX idx_indexed_table_search_field ON indexed_table(search_field);
```

---

## 3. Data Type Mapping Rules (STRICT COMPLIANCE)

### **Rule 3.1: Exact Type Matching**
| SQLAlchemy Type | PostgreSQL Type | Migration SQL |
|----------------|------------------|---------------|
| `BigInteger` | `BIGINT` | `BIGINT` or `BIGSERIAL` |
| `String(255)` | `VARCHAR(255)` | `VARCHAR(255)` |
| `Boolean` | `BOOLEAN` | `BOOLEAN` |
| `DECIMAL(10,3)` | `DECIMAL(10,3)` | `DECIMAL(10,3)` |
| `Text` | `TEXT` | `TEXT` |
| `ARRAY(BigInteger)` | `BIGINT[]` | `BIGINT[]` |
| `JSONB` | `JSONB` | `JSONB` |
| `TIMESTAMP WITH TIME ZONE` | `TIMESTAMPTZ` | `TIMESTAMP WITH TIME ZONE` |

### **Rule 3.2: Constraint Matching**
```python
# Model Constraints
class ConstrainedModel(Base, BaseModel):
    email = Column(String(255), nullable=False, unique=True)
    age = Column(Integer, CheckConstraint('age >= 0'))
```
```sql
-- Required Migration Constraints
ALTER TABLE constrained_model
ADD CONSTRAINT uq_constrained_model_email UNIQUE (email);

ALTER TABLE constrained_model
ADD CONSTRAINT chk_constrained_model_age CHECK (age >= 0);
```

---

## 4. Validation and Testing Requirements

### **Rule 4.1: Pre-Deployment Validation**
**MANDATORY checks before any deployment:**

1. **Schema Comparison**:
```bash
# ✅ REQUIRED: Compare generated SQLAlchemy schema with actual database
python compare_schema.py --check-models-vs-db
```

2. **Model Loading Test**:
```python
# ✅ REQUIRED: Verify all models load without errors
from GEPPPlatform.models import *
from GEPPPlatform.database import get_session

with get_session() as session:
    # Test that all models can be queried
    for model_class in Base.registry._class_map.values():
        session.query(model_class).limit(1).all()
```

3. **Migration Rollback Test**:
```sql
-- ✅ REQUIRED: Test migration rollback capability
BEGIN;
-- Apply migration
-- Test rollback SQL
ROLLBACK;
```

### **Rule 4.2: Integration Testing**
```python
# ✅ REQUIRED: Test model operations after migration
def test_new_model_crud():
    with get_session() as session:
        # Test CREATE
        new_record = NewModel(field_name="test")
        session.add(new_record)
        session.commit()

        # Test READ
        retrieved = session.query(NewModel).filter_by(field_name="test").first()
        assert retrieved is not None

        # Test UPDATE
        retrieved.field_name = "updated"
        session.commit()

        # Test DELETE (soft delete)
        retrieved.is_active = False
        session.commit()
```

---

## 5. File Organization and Documentation

### **Rule 5.1: Migration File Naming**
```bash
# ✅ REQUIRED: Migration file naming convention
backend/migrations/YYYYMMDD_HHMMSS_###_descriptive_name.sql
# Example:
backend/migrations/20250923_140000_024_materials_restructure.sql
```

### **Rule 5.2: Model File Organization**
```bash
# ✅ REQUIRED: Model file structure
backend/GEPPPlatform/models/
├── cores/
│   ├── references.py      # Material models, currencies, etc.
│   ├── locations.py       # Geographic hierarchy
│   └── permissions.py     # Permission system
├── users/
│   └── user_location.py   # User and location models
├── subscriptions/
└── base.py               # BaseModel definition
```

### **Rule 5.3: Documentation Updates**
**MANDATORY documentation updates for every schema change:**

1. **Model Docstrings**:
```python
class MaterialTag(Base, BaseModel):
    """
    Material tags for waste material conditions.

    Can be organization-specific or global tags for categorizing
    waste materials by color, quality, processing state, etc.

    Examples: 'red', 'blue', 'good quality', 'baled', 'contaminated'
    """
    __tablename__ = 'material_tags'
```

2. **Migration Comments**:
```sql
-- Material Tags Table
-- Purpose: Store waste material condition tags for organizations
-- Usage: Tags can be global (available to all orgs) or org-specific
COMMENT ON TABLE material_tags IS 'Material tags for waste material conditions, can be organization-specific or global';
```

3. **Relationship Documentation**:
```python
# ✅ REQUIRED: Document all relationships
organization = relationship("Organization", back_populates="material_tags")
# Documents the inverse relationship
```

---

## 6. Error Handling and Rollback Procedures

### **Rule 6.1: Migration Failure Protocol**
```sql
-- ✅ REQUIRED: Every migration must be transactional
BEGIN;

-- Migration operations here
CREATE TABLE new_table (...);
ALTER TABLE existing_table ADD COLUMN new_field VARCHAR(255);

-- Verification queries
SELECT COUNT(*) FROM new_table; -- Should not fail

-- Only commit if all operations succeed
COMMIT;
-- If any operation fails, automatic ROLLBACK
```

### **Rule 6.2: Model Update Failure Protocol**
```python
# ✅ REQUIRED: Model validation on startup
def validate_models_on_startup():
    """Validate that all models match database schema."""
    try:
        # Test model loading
        Base.metadata.reflect(bind=engine)

        # Verify critical relationships work
        with get_session() as session:
            session.query(Material).join(BaseMaterial).limit(1).all()

    except Exception as e:
        logger.error(f"Model validation failed: {e}")
        raise SystemError("Models do not match database schema")
```

### **Rule 6.3: Rollback SQL Requirements**
```sql
-- ✅ REQUIRED: Every migration file must include rollback instructions
-- ROLLBACK INSTRUCTIONS:
-- To undo this migration, run the following:
--
-- DROP TABLE IF EXISTS material_tags;
-- DROP TABLE IF EXISTS material_tag_groups;
-- DROP TABLE IF EXISTS base_materials;
-- ALTER TABLE materials DROP COLUMN IF EXISTS base_material_id;
-- ALTER TABLE materials DROP COLUMN IF EXISTS tags;
-- ALTER TABLE materials ADD COLUMN category_id BIGINT REFERENCES material_categories(id);
-- ALTER TABLE materials ADD COLUMN main_material_id BIGINT REFERENCES main_materials(id);
```

---

## 7. Enforcement and Code Review Requirements

### **Rule 7.1: Mandatory Code Review Checks**
**❌ AUTOMATIC CODE REJECTION for:**
- Migration without corresponding model updates
- Model changes without migration scripts
- Data type mismatches between model and migration
- Missing foreign key relationships
- Missing indexes specified in models
- Incomplete rollback procedures

### **Rule 7.2: Review Checklist**
```markdown
## Database Schema Change Review Checklist

### Migration Script Review
- [ ] Migration file follows naming convention
- [ ] All table/column changes documented with COMMENT
- [ ] Data types match SQLAlchemy model exactly
- [ ] Foreign keys match model relationships
- [ ] Indexes match model index specifications
- [ ] Constraints match model constraints
- [ ] Rollback instructions provided

### Model Update Review
- [ ] Model class updated to match migration
- [ ] All new columns added to model
- [ ] Data types match migration exactly
- [ ] Relationships added for new foreign keys
- [ ] Model imports updated in __init__.py
- [ ] Model docstrings added/updated

### Testing Review
- [ ] Migration tested with rollback
- [ ] Model loading test passes
- [ ] CRUD operations work on new/modified models
- [ ] Integration tests updated for schema changes
- [ ] Performance impact assessed

### Documentation Review
- [ ] Model docstrings updated
- [ ] Migration comments added
- [ ] API documentation updated if needed
- [ ] Database architecture docs updated
```

---

## 8. Performance and Monitoring

### **Rule 8.1: Performance Impact Assessment**
```sql
-- ✅ REQUIRED: Assess performance impact of schema changes
-- Before migration:
EXPLAIN ANALYZE SELECT * FROM materials WHERE is_active = true;

-- After migration:
EXPLAIN ANALYZE SELECT m.*, bm.name_en
FROM materials m
JOIN base_materials bm ON m.base_material_id = bm.id
WHERE m.is_active = true;

-- Performance comparison required for approval
```

### **Rule 8.2: Index Performance Monitoring**
```sql
-- ✅ REQUIRED: Monitor index usage after deployment
SELECT
    schemaname,
    tablename,
    indexname,
    idx_scan,
    idx_tup_read,
    idx_tup_fetch
FROM pg_stat_user_indexes
WHERE tablename IN ('material_tags', 'material_tag_groups', 'base_materials', 'materials')
ORDER BY idx_scan DESC;
```

---

## 9. Deployment Pipeline Integration

### **Rule 9.1: CI/CD Pipeline Requirements**
```yaml
# ✅ REQUIRED: CI pipeline steps for schema changes
database_validation:
  steps:
    - name: "Validate Model-Migration Sync"
      run: python scripts/validate_schema_sync.py

    - name: "Test Migration Rollback"
      run: python scripts/test_migration_rollback.py

    - name: "Model Loading Test"
      run: python scripts/test_model_loading.py

    - name: "Schema Comparison"
      run: python scripts/compare_models_vs_db.py
```

### **Rule 9.2: Deployment Order**
```bash
# ✅ REQUIRED: Deployment sequence
1. Deploy migration scripts to database
2. Verify migration success
3. Deploy application with updated models
4. Run post-deployment validation
5. Monitor performance metrics
```

---

## 10. Violation Penalties and Remediation

### **Rule 10.1: Immediate Actions for Violations**
- **Production Issues**: Immediate rollback of both migration and model changes
- **Development Issues**: Mandatory fix before any code merge
- **Repeated Violations**: Code review privilege suspension

### **Rule 10.2: Remediation Process**
1. **Identify Mismatch**: Use automated tools to detect schema-model differences
2. **Create Fix**: Generate corrective migration or model changes
3. **Test Fix**: Comprehensive testing in staging environment
4. **Document Issue**: Update procedures to prevent recurrence
5. **Deploy Fix**: Follow standard deployment pipeline

---

## Summary

**These regulations ensure:**
- ✅ **Data Integrity**: Database schema always matches application models
- ✅ **System Reliability**: No runtime errors from schema mismatches
- ✅ **Developer Productivity**: Clear procedures prevent confusion
- ✅ **Deployment Safety**: Rollback procedures for all changes
- ✅ **Performance Optimization**: Index and constraint synchronization
- ✅ **Audit Compliance**: Complete change tracking and documentation

**Enforcement Level:** MANDATORY - Zero tolerance for violations
**Review Frequency:** Every schema change must pass validation
**Tools Required:** Automated schema comparison and validation scripts

**Last Updated:** September 23, 2025
**Version:** v1.0.0
**Status:** ENFORCED REGULATION