# Model Updates v0.0.4 - January 22, 2026

## Overview
This document outlines the implementation of the **AI Audit Rule Sets System** for managing different AI audit configurations per organization, including database schema creation and model definitions.

## Changes Summary

### 1. New Database Table: `ai_audit_rule_sets`

#### Purpose
The `ai_audit_rule_sets` table stores different AI audit rule set configurations that can be assigned to organizations. This allows for flexible AI audit behavior based on organization-specific requirements.

#### Schema Definition

```sql
CREATE TABLE IF NOT EXISTS ai_audit_rule_sets (
    id BIGSERIAL PRIMARY KEY,
    name VARCHAR(255) NOT NULL UNIQUE,
    function_name VARCHAR(255) NOT NULL,
    created_date TIMESTAMPTZ NOT NULL DEFAULT NOW(),
    updated_date TIMESTAMPTZ NOT NULL DEFAULT NOW(),
    deleted_date TIMESTAMPTZ,
    is_active BOOLEAN NOT NULL DEFAULT TRUE
);
```

#### Column Descriptions

| Column | Type | Description |
|--------|------|-------------|
| id | BIGSERIAL | Primary key |
| name | VARCHAR(255) | Human-readable name of the audit rule set (unique) |
| function_name | VARCHAR(255) | Function name to be used for this audit rule set in the backend |
| created_date | TIMESTAMPTZ | Timestamp when the rule set was created |
| updated_date | TIMESTAMPTZ | Timestamp when the rule set was last updated |
| deleted_date | TIMESTAMPTZ | Timestamp when the rule set was soft deleted |
| is_active | BOOLEAN | Whether the rule set is currently active |

#### Default Data

Two default rule sets are created:

| ID | Name | Function Name |
|----|------|---------------|
| 1 | default | default_audit_rule_set |
| 2 | bma | bma_audit_rule_set |

#### Database Indexes

- `idx_ai_audit_rule_sets_name`: Unique name lookup
- `idx_ai_audit_rule_sets_function_name`: Function name lookup
- `idx_ai_audit_rule_sets_is_active`: Active rule sets filtering

### 2. Organizations Table Updates

#### New Columns

Three new columns were added to the `organizations` table:

```sql
-- AI Audit Rule Set Reference
ai_audit_rule_set_id BIGINT DEFAULT 1 REFERENCES ai_audit_rule_sets(id)

-- AI Audit Configuration Flags
enable_ai_audit_response_setting BOOLEAN DEFAULT FALSE
enable_ai_audit_api BOOLEAN DEFAULT FALSE
```

#### Column Descriptions

| Column | Type | Default | Description |
|--------|------|---------|-------------|
| ai_audit_rule_set_id | BIGINT | 1 | Foreign key reference to ai_audit_rule_sets. Determines which AI audit rule set to use |
| enable_ai_audit_response_setting | BOOLEAN | FALSE | Controls whether AI audit response settings are enabled |
| enable_ai_audit_api | BOOLEAN | FALSE | Controls whether AI audit API access is enabled |

#### Foreign Key Constraints

- `fk_organizations_ai_audit_rule_set_id`: Links organizations to their assigned AI audit rule set
  - ON DELETE SET NULL: If a rule set is deleted, organizations default to NULL (can be updated to default rule set)

#### Database Indexes

- `idx_organizations_ai_audit_rule_set_id`: Performance optimization for rule set lookups
- `idx_organizations_enable_ai_audit_response_setting`: Partial index for enabled organizations
- `idx_organizations_enable_ai_audit_api`: Partial index for API-enabled organizations

### 3. File Changes

#### New Files Created

1. **`backend/migrations/20260122_100000_001_create_ai_audit_rule_sets_table.sql`**
   - Table schema creation
   - Indexes and constraints
   - Triggers for updated_date
   - Default data insertion
   - Comments for documentation

2. **`backend/migrations/20260122_110000_002_add_ai_audit_columns_to_organizations.sql`**
   - Column additions to organizations table
   - Foreign key constraint
   - Indexes for performance
   - Column comments

3. **`backend/docs/models/v0.0.4_20260122.md`** (this document)
   - Documentation of changes
   - Usage examples
   - Implementation details

### 4. Technical Implementation Details

#### Multi-Organization Support
- Organizations can be assigned different AI audit rule sets via `ai_audit_rule_set_id`
- Default rule set (ID: 1) is assigned to all organizations by default
- BMA-specific rule set (ID: 2) available for organizations requiring specialized audit rules

#### Configuration Flags
- `enable_ai_audit_response_setting`: Controls granular AI audit response behavior
- `enable_ai_audit_api`: Master switch for AI audit API access
- Both flags default to FALSE for security and opt-in approach

#### Soft Delete Support
- `deleted_date` column enables soft deletion of rule sets
- Prevents data loss while maintaining referential integrity
- Allows for audit trail and recovery of deleted configurations

### 5. Migration Execution Order

1. **20260122_100000_001**: Create ai_audit_rule_sets table and insert default data
2. **20260122_110000_002**: Add AI audit columns to organizations table

### 6. Usage Examples

#### Querying Organizations by Rule Set

```python
from models import Organization, AiAuditRuleSet

# Get all organizations using default rule set
default_orgs = session.query(Organization).filter(
    Organization.ai_audit_rule_set_id == 1,
    Organization.is_active == True
).all()

# Get all organizations with AI audit API enabled
api_enabled_orgs = session.query(Organization).filter(
    Organization.enable_ai_audit_api == True
).all()
```

#### Assigning Rule Sets to Organizations

```python
# Assign BMA rule set to an organization
organization = session.query(Organization).filter(
    Organization.id == org_id
).first()

organization.ai_audit_rule_set_id = 2  # BMA rule set
organization.enable_ai_audit_api = True
organization.enable_ai_audit_response_setting = True

session.commit()
```

#### Getting Rule Set Information

```python
from models import AiAuditRuleSet

# Get rule set for an organization
organization = session.query(Organization).filter(
    Organization.id == org_id
).first()

rule_set = session.query(AiAuditRuleSet).filter(
    AiAuditRuleSet.id == organization.ai_audit_rule_set_id
).first()

print(f"Organization uses: {rule_set.name}")
print(f"Function: {rule_set.function_name}")
```

### 7. Future Enhancements

1. **Dynamic Rule Set Management**: Web interface for creating and managing custom rule sets
2. **Rule Set Templates**: Predefined templates for different industries or use cases
3. **A/B Testing**: Support for testing different rule sets with the same organization
4. **Performance Monitoring**: Tracking rule set effectiveness and performance metrics
5. **Version Control**: Versioning of rule sets for change management

### 8. Validation and Testing

#### Migration Validation

```sql
-- Verify ai_audit_rule_sets table was created
SELECT COUNT(*) FROM ai_audit_rule_sets;
-- Expected: 2 (default and bma)

-- Verify organizations columns were added
SELECT column_name, data_type, column_default
FROM information_schema.columns
WHERE table_name = 'organizations'
AND column_name IN ('ai_audit_rule_set_id', 'enable_ai_audit_response_setting', 'enable_ai_audit_api');
```

#### Data Integrity Checks

```sql
-- Verify all organizations have valid rule set references
SELECT COUNT(*) FROM organizations
WHERE ai_audit_rule_set_id IS NOT NULL
AND ai_audit_rule_set_id NOT IN (SELECT id FROM ai_audit_rule_sets);
-- Expected: 0 (no invalid references)

-- Check default values are applied
SELECT
    COUNT(*) as total_orgs,
    SUM(CASE WHEN ai_audit_rule_set_id = 1 THEN 1 ELSE 0 END) as default_rule_set,
    SUM(CASE WHEN enable_ai_audit_response_setting = FALSE THEN 1 ELSE 0 END) as response_disabled,
    SUM(CASE WHEN enable_ai_audit_api = FALSE THEN 1 ELSE 0 END) as api_disabled
FROM organizations;
```

### 9. Security and Privacy Considerations

#### Opt-In Approach
- All AI audit features default to disabled (FALSE)
- Organizations must explicitly enable AI audit capabilities
- Provides compliance with privacy regulations and data governance policies

#### Access Control
- `enable_ai_audit_api` acts as organization-level permission gate
- Additional authentication and authorization checks should be implemented at API level
- Audit logs should track all AI audit operations

#### Data Protection
- Rule sets stored separately from sensitive organizational data
- Function names provide abstraction layer for implementation details
- Soft delete ensures audit trail for compliance

## Conclusion

The AI Audit Rule Sets System provides a flexible, scalable foundation for managing different AI audit configurations across organizations with:
- Configurable rule sets for different organizational needs
- Granular control over AI audit features
- Performance-optimized database design with proper indexing
- Security-first approach with opt-in defaults
- Extensibility for future enhancements

This implementation supports diverse organizational requirements while maintaining data integrity, security, and performance.

---

## Production Readiness Checklist

### âœ… Completed
- [x] **Database Schema**: ai_audit_rule_sets table created
- [x] **Foreign Keys**: Proper relationships with ON DELETE behavior
- [x] **Indexes**: Performance optimization for common queries
- [x] **Default Data**: Initial rule sets populated
- [x] **Triggers**: Automatic updated_date management
- [x] **Comments**: Database documentation for maintainability
- [x] **Soft Delete**: Support for deleted_date pattern
- [x] **Documentation**: Complete implementation guide

### ðŸ”„ Deployment Requirements
- [ ] **Run Migrations**: Execute migrations in correct order
- [ ] **Update Models**: Update Python models to reflect new columns
- [ ] **Update Services**: Implement rule set selection logic in audit services
- [ ] **API Updates**: Expose rule set configuration in relevant APIs
- [ ] **Testing**: Unit and integration tests for new functionality
- [ ] **Monitoring**: Add metrics for rule set usage and performance

The AI Audit Rule Sets System is **migration-ready** with enterprise-grade database design, proper constraints, and comprehensive documentation! ðŸš€
