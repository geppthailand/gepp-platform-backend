# Backend Version 0.0.8 - Location Tags System & QR Input Enhancements

**Release Date**: January 14, 2026
**Status**: Production Ready
**Migration Required**: Yes - Migration 20260114_100000_001

---

## Overview

This release introduces the **Location Tags System** for organizing and categorizing waste origin points within locations. Tags can be assigned to locations with optional date ranges for time-based events or campaigns.

Key features:
1. **Location Tags Table**: New `user_location_tags` table for managing tags
2. **Location Tags API**: Complete CRUD endpoints for tag management
3. **QR Input Location Fix**: Fixed empty locations issue for organization-level QR channels

---

## Major Features

### 1. Location Tags System

**New Database Table: `user_location_tags`**
- Tracks location tags with metadata
- Supports time-based tags (events with start/end dates)
- Member assignment for tag-based access control
- Organization-level isolation

**Key Columns**:
```sql
- id: SERIAL PRIMARY KEY
- name: VARCHAR(255) NOT NULL
- note: TEXT
- user_location_id: INTEGER (Foreign Key to user_locations)
- organization_id: INTEGER (Foreign Key to organizations)
- created_by_id: INTEGER (Foreign Key to user_locations)
- members: JSONB (Array of user_location IDs)
- start_date: TIMESTAMP WITH TIME ZONE
- end_date: TIMESTAMP WITH TIME ZONE
- is_active: BOOLEAN DEFAULT true
- created_date, updated_date, deleted_date: TIMESTAMP WITH TIME ZONE
```

**Indexes**:
- `idx_user_location_tags_user_location_id`
- `idx_user_location_tags_organization_id`
- `idx_user_location_tags_is_active`
- `idx_user_location_tags_deleted_date`

---

## API Changes

### New Endpoints

#### 1. GET /api/locations/tags
**List location tags for organization or specific location**

**Query Parameters**:
| Parameter | Type | Description |
|-----------|------|-------------|
| user_location_id | integer | Optional - Filter tags by location |
| include_inactive | boolean | Optional - Include inactive tags |

**Response**:
```json
{
  "tags": [
    {
      "id": 1,
      "name": "Warehouse A",
      "note": "Main warehouse",
      "user_location_id": 5,
      "location_name": "Building 1",
      "organization_id": 3,
      "created_by_id": 1,
      "creator_name": "Admin User",
      "members": [10, 11, 12],
      "member_details": [
        {"id": 10, "display_name": "John", "is_user": true, "is_location": false}
      ],
      "start_date": "2026-01-01T00:00:00+00:00",
      "end_date": "2026-12-31T23:59:59+00:00",
      "is_active": true,
      "created_date": "2026-01-14T08:00:00+00:00"
    }
  ],
  "total": 1
}
```

#### 2. GET /api/locations/tags/{tag_id}
**Get single tag by ID**

**Response**:
```json
{
  "tag": {
    "id": 1,
    "name": "Warehouse A",
    ...
  }
}
```

#### 3. POST /api/locations/tags
**Create new location tag**

**Request Body**:
```json
{
  "name": "Event Tag",
  "user_location_id": 5,
  "note": "Optional description",
  "members": [10, 11],
  "start_date": "2026-01-01",
  "end_date": "2026-03-31"
}
```

**Response**:
```json
{
  "tag": {...},
  "message": "Location tag created successfully"
}
```

#### 4. PUT /api/locations/tags/{tag_id}
**Update existing tag**

**Request Body**:
```json
{
  "name": "Updated Name",
  "note": "Updated note",
  "members": [10, 11, 12],
  "start_date": "2026-02-01",
  "end_date": null,
  "is_active": true
}
```

**Response**:
```json
{
  "tag": {...},
  "message": "Location tag updated successfully"
}
```

#### 5. DELETE /api/locations/tags/{tag_id}
**Delete tag (soft delete)**

**Response**:
```json
{
  "message": "Location tag deleted successfully"
}
```

---

## Bug Fixes

### QR Input Location Fix

**Issue**: When accessing QR input page (`/input/:hash`), locations array was empty for organization-level channels where `user_location_id` is null.

**Root Cause**: The `_get_user_locations` method in `input_channel_service.py` was returning early if `channel.user_location_id` was null, without fetching locations.

**Fix**: Updated `_get_user_locations` to query locations directly using `channel.organization_id`:

```python
# Before (broken)
def _get_user_locations(self, channel: UserInputChannel) -> List[Dict[str, Any]]:
    user_location = self.db.query(UserLocation).filter(
        UserLocation.id == channel.user_location_id
    ).first()

    if not user_location:
        return []  # <-- Bug: Returns empty for org-level channels
    ...

# After (fixed)
def _get_user_locations(self, channel: UserInputChannel) -> List[Dict[str, Any]]:
    # Get all locations in the organization directly
    locations = self.db.query(UserLocation).filter(
        and_(
            UserLocation.organization_id == channel.organization_id,
            UserLocation.is_location == True,
            UserLocation.is_active == True,
            UserLocation.deleted_date.is_(None)
        )
    ).all()
```

---

## Database Changes

### Migration: 20260114_100000_001_create_user_location_tags.sql

**What It Does**:
1. Creates `user_location_tags` table with all columns
2. Creates 4 indexes for query optimization
3. Adds foreign key constraints to `user_locations` and `organizations`
4. Adds table and column comments for documentation

**How to Run**:
```bash
cd backend/migrations
psql -U your_user -d your_database -f 20260114_100000_001_create_user_location_tags.sql
```

**Verification**:
```sql
-- Check table exists
SELECT tablename FROM pg_tables WHERE tablename = 'user_location_tags';

-- Check indexes
SELECT indexname FROM pg_indexes WHERE tablename = 'user_location_tags';

-- Check tag count
SELECT COUNT(*) FROM user_location_tags;
```

---

## New Models

### UserLocationTag Model
**Location**: `backend/GEPPPlatform/models/users/user_related.py`

```python
class UserLocationTag(Base, BaseModel):
    """Location tags for categorizing waste origin points within locations."""
    __tablename__ = 'user_location_tags'

    name = Column(String(255), nullable=False)
    note = Column(Text)
    user_location_id = Column(ForeignKey('user_locations.id'), nullable=False)
    organization_id = Column(BigInteger, ForeignKey('organizations.id'), nullable=False)
    created_by_id = Column(ForeignKey('user_locations.id'))
    members = Column(JSON, default=list)
    start_date = Column(DateTime(timezone=True))
    end_date = Column(DateTime(timezone=True))

    # Relationships
    user_location = relationship("UserLocation", foreign_keys=[user_location_id])
    created_by = relationship("UserLocation", foreign_keys=[created_by_id])
    organization = relationship("Organization")
```

**Export**:
- Added to `backend/GEPPPlatform/models/users/__init__.py`
- Available as: `from models.users import UserLocationTag`

---

## New Services

### LocationTagService
**Location**: `backend/GEPPPlatform/services/cores/users/location_tag_service.py`

**Methods**:
```python
class LocationTagService:
    def get_tags_by_location(user_location_id, organization_id, include_inactive) -> List[Dict]
    def get_tags_by_organization(organization_id, include_inactive) -> List[Dict]
    def get_tag_by_id(tag_id, organization_id) -> Optional[Dict]
    def create_tag(user_location_id, organization_id, data, created_by_id) -> Dict
    def update_tag(tag_id, organization_id, data) -> Dict
    def delete_tag(tag_id, organization_id, hard_delete) -> bool
    def assign_members_to_tag(tag_id, organization_id, member_ids) -> Dict
```

---

## Files Changed

### Backend Files Modified
1. `backend/GEPPPlatform/models/users/user_related.py` - Added UserLocationTag model
2. `backend/GEPPPlatform/models/users/__init__.py` - Export UserLocationTag
3. `backend/GEPPPlatform/services/cores/users/user_handlers.py` - Added tag route handlers
4. `backend/GEPPPlatform/services/cores/users/input_channel_service.py` - Fixed location loading

### New Backend Files
1. `backend/migrations/20260114_100000_001_create_user_location_tags.sql` - Migration
2. `backend/GEPPPlatform/services/cores/users/location_tag_service.py` - Tag service

---

## Testing

### Test Commands
```bash
# List tags for organization
curl -X GET "http://localhost:8000/api/locations/tags" \
  -H "Authorization: Bearer $TOKEN"

# Get tags for specific location
curl -X GET "http://localhost:8000/api/locations/tags?user_location_id=5" \
  -H "Authorization: Bearer $TOKEN"

# Create tag
curl -X POST "http://localhost:8000/api/locations/tags" \
  -H "Authorization: Bearer $TOKEN" \
  -H "Content-Type: application/json" \
  -d '{"name": "Test Tag", "user_location_id": 5}'

# Update tag
curl -X PUT "http://localhost:8000/api/locations/tags/1" \
  -H "Authorization: Bearer $TOKEN" \
  -H "Content-Type: application/json" \
  -d '{"name": "Updated Tag"}'

# Delete tag
curl -X DELETE "http://localhost:8000/api/locations/tags/1" \
  -H "Authorization: Bearer $TOKEN"
```

---

## Breaking Changes

**None** - This release is fully backward compatible.

---

## Migration Guide

### For Developers

No code changes required for existing functionality. The new Location Tags API is additive.

To use location tags:
1. Run the migration to create the table
2. Use `/api/locations/tags` endpoints to manage tags
3. Tags can be filtered by `user_location_id` for location-specific views

---

## Release Summary

### What's New in 0.0.8
1. **Location Tags System** (Migration 001)
   - New `user_location_tags` table
   - Complete CRUD API for tag management
   - Support for time-based tags with date ranges
   - Member assignment for access control

2. **QR Input Location Fix**
   - Fixed empty locations for organization-level QR channels
   - Locations now load correctly from organization

### Migration Status
- Migration 20260114_100000_001: Required (Location tags table)

### Backward Compatibility
**100% Backward Compatible** - All existing code continues to work without modifications

---

**Version**: 0.0.8
**Release Date**: 2026-01-14
**Status**: Production Ready
**Breaking Changes**: None
**Migrations Required**: Yes (1 migration)
