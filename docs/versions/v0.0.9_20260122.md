# Backend Version 0.0.9 - AI Audit Response System

**Release Date**: January 22, 2026
**Status**: Production Ready
**Migration Required**: Yes - 3 migrations required
**Breaking Changes**: None

---

## Overview

This release introduces a comprehensive **AI Audit Response Management System** that enables organizations to customize AI-generated audit response messages based on configurable rule sets and patterns. The system uses LangChain with YAML-based prompt templates for waste classification auditing.

**Key Features**:
1. **AI Audit Rule Sets**: Configurable rule sets (default & BMA) for different audit requirements
2. **Response Pattern Management**: JSONB-based pattern matching with priority ordering
3. **LangChain Prompt Templates**: YAML-based prompts for 4 waste types
4. **Organization-Level Configuration**: Enable/disable AI audit features per organization
5. **Pattern Condition Matching**: Flexible condition evaluation for automated responses

---

## Major Features

### 1. AI Audit Rule Sets Table

**New Database Table: `ai_audit_rule_sets`**

Stores different AI audit rule set configurations that can be assigned to organizations.

**Schema**:
```sql
CREATE TABLE ai_audit_rule_sets (
    id BIGSERIAL PRIMARY KEY,
    name VARCHAR(255) NOT NULL UNIQUE,
    function_name VARCHAR(255) NOT NULL,
    created_date TIMESTAMPTZ NOT NULL DEFAULT NOW(),
    updated_date TIMESTAMPTZ NOT NULL DEFAULT NOW(),
    deleted_date TIMESTAMPTZ,
    is_active BOOLEAN NOT NULL DEFAULT TRUE
);
```

**Default Data**:
| ID | Name | Function Name |
|----|------|---------------|
| 1 | default | default_audit_rule_set |
| 2 | bma | bma_audit_rule_set |

**Indexes**:
- `idx_ai_audit_rule_sets_name` - Name lookup
- `idx_ai_audit_rule_sets_function_name` - Function name lookup
- `idx_ai_audit_rule_sets_is_active` - Active status filtering

---

### 2. AI Audit Response Patterns Table

**New Database Table: `ai_audit_response_patterns`**

Stores customizable response message templates with conditions and priorities for generating Thai language audit feedback.

**Schema**:
```sql
CREATE TABLE ai_audit_response_patterns (
    id BIGSERIAL PRIMARY KEY,
    name VARCHAR(255) NOT NULL,
    condition JSONB NOT NULL DEFAULT '[]',
    priority INTEGER NOT NULL DEFAULT 0,
    pattern TEXT NOT NULL,
    organization_id BIGINT NOT NULL REFERENCES organizations(id) ON DELETE CASCADE,
    created_date TIMESTAMPTZ NOT NULL DEFAULT NOW(),
    updated_date TIMESTAMPTZ NOT NULL DEFAULT NOW(),
    deleted_date TIMESTAMPTZ,
    is_active BOOLEAN NOT NULL DEFAULT TRUE
);
```

**Key Columns**:
- `condition`: JSONB array of condition expressions (e.g., `["remark.code == 'wrong_category'"]`)
- `priority`: 0 = highest priority, larger numbers = lower priority
- `pattern`: Thai message template with placeholders (e.g., `"จากรูป {claimed_type} ตรวจพบว่าเป็น {remark.details.detected}"`)

**Indexes**:
- `idx_ai_audit_response_patterns_organization_id` - Organization filtering
- `idx_ai_audit_response_patterns_priority` - Priority-based ordering
- `idx_ai_audit_response_patterns_condition_gin` - JSONB condition querying

**Example Pattern**:
```json
{
  "name": "Wrong Category - Recyclable to Organic",
  "condition": [
    "remark.code == 'wrong_category'",
    "claimed_type == 'recyclable'",
    "remark.details.detected contains 'organic'"
  ],
  "priority": 0,
  "pattern": "จากรูป {claimed_type} ตรวจพบว่าเป็น {remark.details.detected} เนื่องจากพบ {remark.details.reason}"
}
```

---

### 3. Organizations Table Updates

**Updated Table: `organizations`**

Added three new columns for AI audit configuration:

```sql
ALTER TABLE organizations
ADD COLUMN ai_audit_rule_set_id BIGINT DEFAULT 1 REFERENCES ai_audit_rule_sets(id),
ADD COLUMN enable_ai_audit_response_setting BOOLEAN DEFAULT FALSE,
ADD COLUMN enable_ai_audit_api BOOLEAN DEFAULT FALSE;
```

**Column Descriptions**:
| Column | Type | Default | Description |
|--------|------|---------|-------------|
| `ai_audit_rule_set_id` | BIGINT | 1 | Foreign key to ai_audit_rule_sets (1=default, 2=bma) |
| `enable_ai_audit_response_setting` | BOOLEAN | FALSE | Enable response pattern customization UI |
| `enable_ai_audit_api` | BOOLEAN | FALSE | Enable AI audit API access |

**Indexes**:
- `idx_organizations_ai_audit_rule_set_id` - Rule set lookups
- `idx_organizations_enable_ai_audit_response_setting` - Partial index for enabled orgs
- `idx_organizations_enable_ai_audit_api` - Partial index for API access

---

### 4. LangChain YAML Prompt Templates

**New Directory Structure**: `backend/GEPPPlatform/prompts/ai_audit/`

```
prompts/ai_audit/
├── default/
│   ├── general.yaml
│   ├── recyclable.yaml
│   ├── organic.yaml
│   └── hazardous.yaml
└── bma/
    ├── general.yaml
    ├── recyclable.yaml
    ├── organic.yaml
    └── hazardous.yaml
```

**Prompt Template Format** (YAML):
```yaml
_type: prompt
input_variables:
  - image_url
  - claimed_type
template: |
  You are an expert waste auditor for BMA waste management system.
  Analyze the image and determine if it correctly represents "{claimed_type}" waste.

  IMAGE URL: {image_url}

  WASTE CLASSIFICATION CRITERIA:
  [Detailed criteria...]

  OUTPUT FORMAT (JSON):
  {
    "claimed_type": "{claimed_type}",
    "audit_status": "pass" or "reject",
    "confidence_score": 0.0 to 1.0,
    "remark": {
      "code": "correct_category" or "wrong_category"...,
      "severity": "info" or "minor" or "critical",
      "details": {...},
      "correction_action": "..."
    }
  }
```

**Prompt Loader Utility** (`prompts/base.py`):
```python
from langchain_core.prompts import load_prompt

class PromptLoader:
    def load_ai_audit_prompt(self, rule_set="default", waste_type="general"):
        """Load AI audit prompt for specific rule set and waste type"""
        return load_prompt(f"ai_audit/{rule_set}/{waste_type}.yaml")

    def get_ai_audit_prompts_for_rule_set(self, rule_set="default"):
        """Load all prompts for a rule set"""
        return {
            "general": self.load_ai_audit_prompt(rule_set, "general"),
            "recyclable": self.load_ai_audit_prompt(rule_set, "recyclable"),
            "organic": self.load_ai_audit_prompt(rule_set, "organic"),
            "hazardous": self.load_ai_audit_prompt(rule_set, "hazardous")
        }
```

**LLM Output Structure**:
```json
{
  "claimed_type": "recyclable",
  "audit_status": "pass" | "reject",
  "confidence_score": 0.95,
  "remark": {
    "code": "wrong_category" | "correct_category" | "contaminated" | "unclear_image",
    "severity": "critical" | "minor" | "info",
    "details": {
      "detected": "organic waste",
      "reason": "visible food scraps on container",
      "items": "plastic bottle with food residue"
    },
    "correction_action": "Remove food scraps and wash container"
  }
}
```

---

## API Changes

### Updated Endpoints

#### GET /api/organizations/me

**Description**: Get current user's organization with AI audit configuration

**Response** (Updated with new fields):
```json
{
  "id": 1,
  "name": "Organization Name",
  "description": "...",
  "allow_ai_audit": true,
  "ai_audit_rule_set_id": 2,
  "enable_ai_audit_response_setting": true,
  "enable_ai_audit_api": true,
  "info": {
    "company_name": "...",
    "account_type": "...",
    "business_type": "...",
    "business_industry": "...",
    "tax_id": "..."
  },
  "created_date": "2025-01-01T00:00:00Z",
  "is_active": true
}
```

**New Response Fields**:
- `ai_audit_rule_set_id`: Which rule set the organization uses (1=default, 2=bma)
- `enable_ai_audit_response_setting`: Whether org can customize response patterns
- `enable_ai_audit_api`: Whether org has AI audit API access

---

### New Endpoints (To Be Implemented)

The following CRUD endpoints for response patterns need backend implementation:

#### 1. GET /api/ai-audit-responses
**List all response patterns for organization**

**Query Parameters**:
- `organization_id` (required): Organization ID

**Response**:
```json
{
  "success": true,
  "data": [
    {
      "id": 1,
      "name": "Wrong Category Pattern",
      "condition": ["remark.code == 'wrong_category'"],
      "priority": 0,
      "pattern": "จากรูป {claimed_type}...",
      "organization_id": 1,
      "created_date": "2026-01-22T10:00:00Z",
      "is_active": true
    }
  ]
}
```

#### 2. POST /api/ai-audit-responses
**Create new response pattern**

**Request Body**:
```json
{
  "name": "Pattern Name",
  "condition": ["condition1", "condition2"],
  "priority": 0,
  "pattern": "Thai message template...",
  "organization_id": 1
}
```

#### 3. PUT /api/ai-audit-responses/{id}
**Update existing response pattern**

#### 4. DELETE /api/ai-audit-responses/{id}
**Delete response pattern (soft delete)**

---

## Database Changes

### Migrations

Three migrations required in sequential order:

#### 1. Migration: 20260122_100000_001_create_ai_audit_rule_sets_table.sql

**Creates**:
- `ai_audit_rule_sets` table
- Indexes for name, function_name, is_active
- Trigger for updated_date
- Default data (default & bma rule sets)

**Run Command**:
```bash
psql -U user -d database -f 20260122_100000_001_create_ai_audit_rule_sets_table.sql
```

#### 2. Migration: 20260122_110000_002_add_ai_audit_columns_to_organizations.sql

**Creates**:
- Three new columns in organizations table
- Foreign key constraint to ai_audit_rule_sets
- Indexes for performance

**Run Command**:
```bash
psql -U user -d database -f 20260122_110000_002_add_ai_audit_columns_to_organizations.sql
```

#### 3. Migration: 20260122_120000_003_create_ai_audit_response_patterns_table.sql

**Creates**:
- `ai_audit_response_patterns` table
- JSONB condition column
- Priority-based indexing
- Organization foreign key

**Run Command**:
```bash
psql -U user -d database -f 20260122_120000_003_create_ai_audit_response_patterns_table.sql
```

### Verification Commands

```sql
-- Verify tables created
SELECT tablename FROM pg_tables
WHERE tablename IN ('ai_audit_rule_sets', 'ai_audit_response_patterns');

-- Check default rule sets
SELECT * FROM ai_audit_rule_sets;

-- Verify organizations columns
SELECT column_name, data_type
FROM information_schema.columns
WHERE table_name = 'organizations'
AND column_name LIKE 'ai_audit%';
```

---

## New Models

### 1. AiAuditRuleSet Model

**Location**: `backend/GEPPPlatform/models/ai_audit_models.py`

```python
class AiAuditRuleSet(Base, BaseModel):
    """AI Audit Rule Sets - Defines different audit rule configurations"""
    __tablename__ = 'ai_audit_rule_sets'

    name = Column(String(255), nullable=False, unique=True)
    function_name = Column(String(255), nullable=False)

    # Relationships
    organizations = relationship(
        "Organization",
        back_populates="ai_audit_rule_set",
        foreign_keys="Organization.ai_audit_rule_set_id"
    )
```

### 2. AiAuditResponsePattern Model

**Location**: `backend/GEPPPlatform/models/ai_audit_models.py`

```python
class AiAuditResponsePattern(Base, BaseModel):
    """Stores customizable response message templates"""
    __tablename__ = 'ai_audit_response_patterns'

    name = Column(String(255), nullable=False)
    condition = Column(JSONB, nullable=False, default=[])
    priority = Column(Integer, nullable=False, default=0)
    pattern = Column(Text, nullable=False)
    organization_id = Column(
        BigInteger,
        ForeignKey('organizations.id', ondelete='CASCADE'),
        nullable=False
    )

    # Relationships
    organization = relationship(
        "Organization",
        back_populates="ai_audit_response_patterns"
    )
```

### 3. Updated Organization Model

**Location**: `backend/GEPPPlatform/models/subscriptions/organizations.py`

**Added Columns**:
```python
# AI Audit Configuration
ai_audit_rule_set_id = Column(
    BigInteger,
    ForeignKey('ai_audit_rule_sets.id'),
    default=1
)
enable_ai_audit_response_setting = Column(Boolean, default=False)
enable_ai_audit_api = Column(Boolean, default=False)
```

**Added Relationships**:
```python
ai_audit_rule_set = relationship(
    "AiAuditRuleSet",
    back_populates="organizations",
    foreign_keys=[ai_audit_rule_set_id]
)
ai_audit_response_patterns = relationship(
    "AiAuditResponsePattern",
    back_populates="organization",
    cascade="all, delete-orphan"
)
```

---

## New Services

### PromptLoader Service

**Location**: `backend/GEPPPlatform/prompts/base.py`

**Methods**:
```python
class PromptLoader:
    def __init__(self, base_dir: Optional[Path] = None)

    def load_yaml_prompt(self, relative_path: str) -> PromptTemplate

    def load_ai_audit_prompt(
        self,
        rule_set: str = "default",
        waste_type: str = "general"
    ) -> PromptTemplate

    def get_ai_audit_prompts_for_rule_set(
        self,
        rule_set: str = "default"
    ) -> Dict[str, PromptTemplate]
```

**Usage Example**:
```python
from GEPPPlatform.prompts.base import PromptLoader

loader = PromptLoader()

# Load specific prompt
recyclable_prompt = loader.load_ai_audit_prompt(
    rule_set="bma",
    waste_type="recyclable"
)

# Load all prompts for a rule set
bma_prompts = loader.get_ai_audit_prompts_for_rule_set("bma")
# Returns: {"general": ..., "recyclable": ..., "organic": ..., "hazardous": ...}
```

---

## Updated Services

### OrganizationService

**Location**: `backend/GEPPPlatform/services/cores/organizations/organization_service.py`

**Updated Method**: `get_organization_info()`

**Added Response Fields**:
```python
return {
    'id': org.id,
    'name': org.name,
    'allow_ai_audit': org.allow_ai_audit,
    'ai_audit_rule_set_id': org.ai_audit_rule_set_id,              # NEW
    'enable_ai_audit_response_setting': org.enable_ai_audit_response_setting,  # NEW
    'enable_ai_audit_api': org.enable_ai_audit_api,                # NEW
    # ... other fields
}
```

---

## Files Changed

### New Backend Files (10 files)

1. **Migrations** (3 files):
   - `backend/migrations/20260122_100000_001_create_ai_audit_rule_sets_table.sql`
   - `backend/migrations/20260122_110000_002_add_ai_audit_columns_to_organizations.sql`
   - `backend/migrations/20260122_120000_003_create_ai_audit_response_patterns_table.sql`

2. **Models** (1 file):
   - `backend/GEPPPlatform/models/ai_audit_models.py`

3. **Prompts** (9 files):
   - `backend/GEPPPlatform/prompts/__init__.py`
   - `backend/GEPPPlatform/prompts/base.py`
   - `backend/GEPPPlatform/prompts/ai_audit/default/general.yaml`
   - `backend/GEPPPlatform/prompts/ai_audit/default/recyclable.yaml`
   - `backend/GEPPPlatform/prompts/ai_audit/default/organic.yaml`
   - `backend/GEPPPlatform/prompts/ai_audit/default/hazardous.yaml`
   - `backend/GEPPPlatform/prompts/ai_audit/bma/general.yaml`
   - `backend/GEPPPlatform/prompts/ai_audit/bma/recyclable.yaml`
   - `backend/GEPPPlatform/prompts/ai_audit/bma/organic.yaml`
   - `backend/GEPPPlatform/prompts/ai_audit/bma/hazardous.yaml`

### Modified Backend Files (3 files)

1. `backend/GEPPPlatform/models/__init__.py` - Export new models
2. `backend/GEPPPlatform/models/subscriptions/organizations.py` - Add AI audit columns/relationships
3. `backend/GEPPPlatform/services/cores/organizations/organization_service.py` - Return AI audit fields
4. `backend/GEPPPlatform/services/cores/organizations/organization_handlers.py` - Add `/me` endpoint route

---

## System Architecture

### AI Audit Flow

```
┌─────────────────────────────────────────────────────────────┐
│                    User Uploads Transaction                  │
│                      (with waste image)                      │
└───────────────────────────┬─────────────────────────────────┘
                            │
                            ▼
┌─────────────────────────────────────────────────────────────┐
│              AI Audit Service (Future Implementation)         │
│  1. Load organization's ai_audit_rule_set_id                │
│  2. Get corresponding prompt (default or bma)                │
│  3. Select waste type prompt (general/recyclable/etc.)       │
└───────────────────────────┬─────────────────────────────────┘
                            │
                            ▼
┌─────────────────────────────────────────────────────────────┐
│                   LangChain + Vision Model                   │
│  - Load YAML prompt template                                 │
│  - Inject image_url and claimed_type                         │
│  - Process with GPT-4 Vision / similar model                 │
└───────────────────────────┬─────────────────────────────────┘
                            │
                            ▼
┌─────────────────────────────────────────────────────────────┐
│                    Structured JSON Response                  │
│  {                                                           │
│    "claimed_type": "recyclable",                            │
│    "audit_status": "reject",                                │
│    "confidence_score": 0.95,                                │
│    "remark": {                                              │
│      "code": "wrong_category",                              │
│      "severity": "critical",                                │
│      "details": {...}                                        │
│    }                                                         │
│  }                                                           │
└───────────────────────────┬─────────────────────────────────┘
                            │
                            ▼
┌─────────────────────────────────────────────────────────────┐
│              Pattern Matching Service (Future)               │
│  1. Get org's response patterns (sorted by priority)        │
│  2. Evaluate conditions against LLM output                   │
│  3. Find first matching pattern                              │
│  4. Render pattern template with actual values              │
└───────────────────────────┬─────────────────────────────────┘
                            │
                            ▼
┌─────────────────────────────────────────────────────────────┐
│                   Formatted Thai Response                    │
│  "จากรูป recyclable ตรวจพบว่าเป็น organic waste             │
│   เนื่องจากพบ visible food scraps on container"             │
└───────────────────────────┬─────────────────────────────────┘
                            │
                            ▼
┌─────────────────────────────────────────────────────────────┐
│                   Display to User in UI                      │
└─────────────────────────────────────────────────────────────┘
```

---

## Configuration Examples

### Enable AI Audit for Organization

```sql
-- Enable all AI audit features for BMA
UPDATE organizations
SET
    ai_audit_rule_set_id = 2,                      -- Use BMA rule set
    enable_ai_audit_response_setting = TRUE,      -- Enable pattern customization
    enable_ai_audit_api = TRUE,                    -- Enable API access
    allow_ai_audit = TRUE                          -- Master switch
WHERE id = 1;  -- Your organization ID
```

### Create Custom Response Pattern

```sql
INSERT INTO ai_audit_response_patterns (
    name,
    condition,
    priority,
    pattern,
    organization_id
) VALUES (
    'Recyclable Contamination Warning',
    '["remark.code == ''contaminated''", "claimed_type == ''recyclable''"]'::jsonb,
    0,
    'วัสดุรีไซเคิล {claimed_type} มีการปนเปื้อน: {remark.details.reason}. กรุณา{remark.correction_action}',
    1
);
```

---

## Testing

### Manual Testing Commands

```bash
# Test organization endpoint
curl -X GET "http://localhost:8000/api/organizations/me" \
  -H "Authorization: Bearer $TOKEN"

# Expected response includes:
# "ai_audit_rule_set_id": 1,
# "enable_ai_audit_response_setting": false,
# "enable_ai_audit_api": false
```

### Database Testing

```sql
-- Check rule sets
SELECT * FROM ai_audit_rule_sets;

-- Check organization AI audit config
SELECT
    id,
    name,
    ai_audit_rule_set_id,
    enable_ai_audit_response_setting,
    enable_ai_audit_api
FROM organizations;

-- Check response patterns
SELECT * FROM ai_audit_response_patterns;
```

### Python Testing

```python
# Test prompt loader
from GEPPPlatform.prompts.base import PromptLoader

loader = PromptLoader()
prompt = loader.load_ai_audit_prompt("bma", "recyclable")
print(prompt.template)

# Test all prompts load correctly
prompts = loader.get_ai_audit_prompts_for_rule_set("bma")
assert len(prompts) == 4
assert "general" in prompts
assert "recyclable" in prompts
```

---

## Breaking Changes

**None** - This release is fully backward compatible.

All new features are opt-in via database configuration. Existing functionality remains unchanged.

---

## Migration Guide

### For Developers

#### 1. Run Database Migrations

```bash
cd backend/migrations

# Run in order:
psql -U user -d db -f 20260122_100000_001_create_ai_audit_rule_sets_table.sql
psql -U user -d db -f 20260122_110000_002_add_ai_audit_columns_to_organizations.sql
psql -U user -d db -f 20260122_120000_003_create_ai_audit_response_patterns_table.sql
```

#### 2. Import New Models

```python
from GEPPPlatform.models import AiAuditRuleSet, AiAuditResponsePattern
```

#### 3. Use Prompt Loader

```python
from GEPPPlatform.prompts.base import PromptLoader

loader = PromptLoader()
prompt = loader.load_ai_audit_prompt("bma", "recyclable")
```

#### 4. Access Organization AI Audit Settings

```python
org = organization_service.get_organization_by_id(org_id)
if org.enable_ai_audit_api:
    # Use AI audit features
    rule_set = org.ai_audit_rule_set.function_name  # "bma_audit_rule_set"
```

---

## Known Issues

1. **Backend CRUD APIs Not Implemented**: The `/api/ai-audit-responses` endpoints need implementation
2. **Pattern Matching Logic**: The service to match conditions and render patterns needs to be built
3. **LangChain Dependencies**: Requires `langchain` and `langchain-core` packages installation

---

## Dependencies

### New Python Packages Required

```bash
pip install langchain langchain-core
```

### Frontend Dependencies

This release requires **Frontend v0.0.7** which includes:
- AI Response Settings Modal component
- AI Audit Response API Service
- Organization API updates
- Conditional UI rendering based on `enable_ai_audit_response_setting`

---

## Future Enhancements

### Phase 1 (Immediate)
1. **Implement CRUD APIs**: Create backend endpoints for response pattern management
2. **Pattern Matching Service**: Build service to evaluate conditions and render patterns
3. **AI Vision Integration**: Connect prompts to GPT-4 Vision or similar models

### Phase 2 (Near Future)
1. **Batch Pattern Operations**: Import/export patterns, bulk updates
2. **Pattern Testing UI**: Test patterns with sample data
3. **Analytics Dashboard**: Track pattern usage and effectiveness
4. **Multi-language Support**: English pattern templates

### Phase 3 (Long Term)
1. **ML-Powered Patterns**: Auto-generate patterns from historical data
2. **A/B Testing**: Test different patterns for effectiveness
3. **Rule Set Marketplace**: Share rule sets between organizations
4. **Advanced Condition Builder**: Visual condition editor

---

## Release Summary

### What's New in 0.0.9

1. **AI Audit Rule Sets System** (Migration 001)
   - New `ai_audit_rule_sets` table
   - Default & BMA rule sets pre-configured
   - Function-based rule set selection

2. **Organizations AI Audit Configuration** (Migration 002)
   - Three new columns for AI audit settings
   - Foreign key to rule sets
   - Opt-in feature flags per organization

3. **Response Pattern Management** (Migration 003)
   - New `ai_audit_response_patterns` table
   - JSONB condition matching
   - Priority-based pattern ordering
   - Thai message templates with placeholders

4. **LangChain Prompt System**
   - YAML-based prompt templates
   - 8 prompts (2 rule sets × 4 waste types)
   - Prompt loader utility with LangChain integration
   - Structured JSON output format

5. **API Enhancements**
   - `/api/organizations/me` returns AI audit settings
   - New model relationships and exports

### Migration Status
- Migration 001: Required (AI audit rule sets)
- Migration 002: Required (Organizations columns)
- Migration 003: Required (Response patterns table)

### Backward Compatibility
**100% Backward Compatible** - All existing code continues to work without modifications. New features are opt-in via database configuration.

---

**Version**: 0.0.9
**Release Date**: 2026-01-22
**Status**: Production Ready
**Breaking Changes**: None
**Migrations Required**: Yes (3 migrations)
**Dependencies**: langchain, langchain-core
**Frontend Version**: Requires v0.0.7
